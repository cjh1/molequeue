find_package(Qt4 4.8.0 COMPONENTS QtCore QtGui QtNetwork)

include(${QT_USE_FILE})

set(JSONCPP_SOURCE_DIR "${MoleQueue_SOURCE_DIR}/thirdparty/jsoncpp/")

include_directories(${CMAKE_CURRENT_BINARY_DIR}
  ${JSONCPP_SOURCE_DIR}
)

# Are we using ZeroMQ
if(USE_ZERO_MQ)
  find_package(ZeroMQ REQUIRED)
  include_directories(${ZeroMQ_INCLUDE_DIR})
  set(mq_zeromq_srcs
    transport/zeromqconnection.cpp
    transport/zeromqconnectionlistener.cpp
    zeromqclient.cpp)
  set(mq_zeromq_moc
    transport/zeromqconnection.h
    transport/zeromqconnectionlistener.h
    zeromqclient.h)
  set(mqclient_zeromq_srcs
    transport/zeromqconnection.cpp
    zeromqclient.cpp)
  set(mqclient_zeromq_moc
    transport/zeromqconnection.h)
  add_definitions(-DUSE_ZERO_MQ)
endif()

set(mq_srcs
  abstractrpcinterface.cpp
  actionfactorymanager.cpp
  addqueuedialog.cpp
  client.cpp
  error.cpp
  job.cpp
  jobactionfactory.cpp
  jobactionfactories/opendirectoryactionfactory.cpp
  jobactionfactories/openwithactionfactory.cpp
  jobactionfactories/programmableopenwithactionfactory.cpp
  jobactionfactories/removejobactionfactory.cpp
  jobitemmodel.cpp
  jobmanager.cpp
  jobtablewidget.cpp
  jobview.cpp
  jsonrpc.cpp
  localsocketclient.cpp
  mainwindow.cpp
  message.cpp
  molequeueglobal.h
  object.cpp
  openwithmanagerdialog.cpp
  openwithexecutablemodel.cpp
  openwithpatternmodel.cpp
  patterntypedelegate.cpp
  program.cpp
  programconfiguredialog.cpp
  queue.cpp
  queuemanager.cpp
  queuemanagerdialog.cpp
  queuemanageritemmodel.cpp
  queueprogramitemmodel.cpp
  queues/local.cpp
  queues/pbs.cpp
  queues/remote.cpp
  queues/sge.cpp
  queuesettingsdialog.cpp
  remotequeuewidget.cpp
  server.cpp
#  serverconnection.cpp
  sshcommand.cpp
  sshconnection.cpp
  terminalprocess.cpp
  transport/localsocketconnection.cpp
  transport/localsocketconnectionlistener.cpp
  ${mq_zeromq_srcs}
)

set(mq_moc
  abstractrpcinterface.h
  actionfactorymanager.h
  addqueuedialog.h
  client.h
  connection.h
  connectionlistener.h
  jobactionfactory.h
  jobactionfactories/opendirectoryactionfactory.h
  jobactionfactories/openwithactionfactory.h
  jobactionfactories/programmableopenwithactionfactory.h
  jobactionfactories/removejobactionfactory.h
  jobitemmodel.h
  jobmanager.h
  jobtablewidget.h
  jobview.h
  jsonrpc.h
  localsocketclient.h
  mainwindow.h
  message.h
  object.h
  openwithmanagerdialog.h
  openwithexecutablemodel.h
  openwithpatternmodel.h
  patterntypedelegate.h
  program.h
  programconfiguredialog.h
  queue.h
  queuemanager.h
  queuemanagerdialog.h
  queuemanageritemmodel.h
  queueprogramitemmodel.h
  queues/local.h
  queues/pbs.h
  queues/remote.h
  queues/sge.h
  queuesettingsdialog.h
  remotequeuewidget.h
  server.h
  serverconnection.h
  sshcommand.h
  sshconnection.h
  terminalprocess.h
  transport/localsocketconnection.h
  transport/localsocketconnectionlistener.h
  ${mq_zeromq_moc}
)

qt4_wrap_cpp(moc_srcs ${mq_moc})

qt4_wrap_ui(ui_srcs
  ui/addqueuedialog.ui
  ui/jobtablewidget.ui
  ui/mainwindow.ui
  ui/openwithmanagerdialog.ui
  ui/programconfiguredialog.ui
  ui/queuemanagerdialog.ui
  ui/queuesettingsdialog.ui
  ui/remotequeuewidget.ui
)
qt4_add_resources(rcc_srcs queuetray.qrc)

# Pull in JsonCpp
aux_source_directory(${JSONCPP_SOURCE_DIR} jsoncpp_srcs)
set(mq_srcs ${mq_srcs} ${jsoncpp_srcs})

# Disable JsonCpp warnings for most platforms
if(BORLAND)
  set_property(SOURCE ${jsoncpp_srcs}
    PROPERTY
    COMPILE_FLAGS "-w-")
else()
  set_property(SOURCE ${jsoncpp_srcs}
    PROPERTY
    COMPILE_FLAGS "-w")
endif()

add_library(molequeue_static STATIC
  ${mq_srcs} ${moc_srcs} ${ui_srcs})

add_executable(molequeue MACOSX_BUNDLE main.cpp ${rcc_srcs})
target_link_libraries(molequeue molequeue_static ${QT_LIBRARIES} ${ZeroMQ_LIBRARIES})
install(TARGETS molequeue
  DESTINATION bin)

if((APPLE OR WIN32) AND NOT ${CMAKE_VERSION} VERSION_LESS 2.8.8)
  set(sfx "")
  if(APPLE)
    set(sfx ".app")
  elseif(WIN32)
    set(sfx ".exe")
  endif()

  set(dirs "")
  if(CMAKE_PREFIX_PATH)
    set(dirs "${CMAKE_PREFIX_PATH}/lib")
  endif()

  include(DeployQt4)
  install_qt4_executable(bin/molequeue${sfx} "" "" "${dirs}")
endif()

if(ENABLE_TESTING)
  add_subdirectory(testing)
endif()

# Client library
set(mqclient_srcs
  abstractrpcinterface.cpp
  client.cpp
  job.cpp
  jobmanager.cpp
  jsonrpc.cpp
  message.cpp
  molequeueglobal.h
  transport/localsocketconnection.cpp
  ${jsoncpp_srcs}
  ${mqclient_zeromq_srcs}
)

set(mqclient_moc
  abstractrpcinterface.h
  client.h
  connection.h
  jobmanager.h
  jsonrpc.h
  transport/localsocketconnection.h
  ${mqclient_zeromq_moc}
)

#TODO need to install these
set(mqclient_headers
  abstractrpcinterface.h
  client.h
  localsocketclient.h
  job.h
  molequeueglobal.h
  ${JSONCPP_SOURCE_DIR}/json/json-forwards.h
)


qt4_wrap_cpp(mqclient_moc_srcs ${mqclient_moc})
add_library(molequeueclient SHARED ${mqclient_srcs} ${mqclient_moc_srcs})
target_link_libraries(molequeueclient ${QT_LIBRARIES} ${ZeroMQ_LIBRARIES})
install(TARGETS molequeueclient DESTINATION lib)
